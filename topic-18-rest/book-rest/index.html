 <!DOCTYPE html>
 <html>
   <head>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

     

     <style>
       

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}



     </style>

   </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom:thin solid black;
}

h2
{
  font-size:110%;
  border-bottom: thin solid black;
}

h3
{
  font-size:100%;
  border-bottom: thin solid black;
}

body
{
  overflow-y: scroll;
}

.pushable > .pusher
{
  padding-bottom: 1.5rem;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}



</style>

<div class="ui fixed top pointing inverted stackable menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      18: REST
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="Lab-18 Rest">
      Lab-18 Rest
    </a>
    
    <a class="item" data-tab="Lab-13-Solutions">
      Lab-13-Solutions
    </a>
    
    <a class="item" data-tab="02">
      02
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" data-tab="05">
      05
    </a>
    
    <a class="item" data-tab="06">
      06
    </a>
    
    <a class="item" data-tab="07.Exercises">
      07.Exercises
    </a>
    
    <div class="item">
      
    </div>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    <br><br>
    
      
        <a class="item" href="../../topic-02-js-review/book-1-javascript-intro/index.html">
          Lab-2.1 JS Intro
        </a>
      
    
      
        <a class="item" href="../../topic-02-js-review/book-2-javascript-fundamentals/index.html">
          Lab-2.2 JS Basics
        </a>
      
    
      
        <a class="item" href="../../topic-03-jquery+dom/book-3-jquery/index.html">
          Lab-3 JQuery
        </a>
      
    
      
        <a class="item" href="../../topic-04-ajax+apis/book-1-ajax-1/index.html">
          Lab-4.1 Github API
        </a>
      
    
      
        <a class="item" href="../../topic-04-ajax+apis/book-2-ajax-2/index.html">
          Lab-4.2-FoureSquare API
        </a>
      
    
      
        <a class="item" href="../../topic-05-applications/book-applications/index.html">
          Lab-5 Applications
        </a>
      
    
      
        <a class="item" href="../../topic-06-views/book-views/index.html">
          Lab-6 Views
        </a>
      
    
      
        <a class="item" href="../../topic-07-sessions/book-sessions/index.html">
          Lab-7 Sessions
        </a>
      
    
      
        <a class="item" href="../../topic-08-models/book-models/index.html">
          Lab-8 Models
        </a>
      
    
      
        <a class="item" href="../../topic-09-validation/book-validation/index.html">
          Lab-9 Validation
        </a>
      
    
      
        <a class="item" href="../../topic-10-deployment/book-deployment/index.html">
          Lab-10 Deployment
        </a>
      
    
      
        <a class="item" href="../../topic-11-seeding/book-seeding/index.html">
          Lab-11 Seeding
        </a>
      
    
      
        <a class="item" href="../../topic-12-api/book-api/index.html">
          Lab-12 Apis
        </a>
      
    
      
        <a class="item" href="../../topic-13-security-introduction/book-1-pgp-gpg/index.html">
          Lab-13 GPG
        </a>
      
    
      
        <a class="item" href="../../topic-14-security-foundations/book-1-openssl/index.html">
          Lab-14 OpenSSL and Certificates
        </a>
      
    
      
        <a class="item" href="../../topic-15-authentication+tls/book-1-tls-configuration/index.html">
          Lab-15 TLS Configuration
        </a>
      
    
      
        <a class="item" href="../../topic-16-tdd/book-tdd/index.html">
          Lab-16 Tdd
        </a>
      
    
      
        <a class="item" href="../../topic-17-webapp-threats+vulnerabilities/book-1-misuse-cases/index.html">
          Lab-17 Misuse Cases
        </a>
      
    
      
        <a class="active item" href="../../topic-18-rest/book-rest/index.html">
          Lab-18 Rest
        </a>
      
    
      
        <a class="item" href="../../topic-19-web-app-authentication/book-1-web-authentication/index.html">
          Lab-19 Authentication techniques
        </a>
      
    
      
        <a class="item" href="../../topic-20-rest-client/book-rest-client/index.html">
          Lab-19 Java Rest Client
        </a>
      
    
      
        <a class="item" href="../../topic-21-aurelia-1/book-aurelia-1/index.html">
          Lab-Aurelia 1
        </a>
      
    
      
        <a class="item" href="../../topic-22-pentesting/book-1-burp-proxy/index.html">
          Lab-Burp-Proxy
        </a>
      
    
      
        <a class="item" href="../../topic-23-aurelia-2/book-aurelia-2/index.html">
          Lab-Aurelia 2
        </a>
      
    
      
        <a class="item" href="../../topic-24-aurelia-3/book-aurelia-3/index.html">
          Lab-Aurelia 3
        </a>
      
    
  </div>
  <div class="pusher" tabindex="-1">
    <div class="ui basic segment" id="labchat">
      <br>
      
      <div  class="ui tab segment lab" data-tab="Lab-18 Rest">
        <h1>Objectives</h1>
<p>Extend the api to support creating and deleting donations. Donations are associated with candidates, so we utilise the url to establish this relationship.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Lab-13-Solutions">
        <h1>Lab 12 Exercise Solutions</h1>
<h2>Exercise 1: Candidates API</h2>
<p>Using <code>candidatesapitest.js</code> as an example, write/rewrite your <code>usersapitest.js</code> to comprehensively exercise the users api.</p>
<h2>donations-service.js</h2>
<pre><code>  deleteOneUser(id) {
    return this.httpService.delete(&#39;/api/users/&#39; + id);
  }

  deleteAllUsers() {
    return this.httpService.delete(&#39;/api/users&#39;);
  }</code></pre>
<h2>usersapitest.js</h2>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const _ = require(&#39;lodash&#39;);

suite(&#39;User API tests&#39;, function () {

  let users = fixtures.users;
  let newUser = fixtures.newUser;

  const donationService = new DonationService(fixtures.donationService);

  beforeEach(function () {
    donationService.deleteAllUsers();
  });

  afterEach(function () {
    donationService.deleteAllUsers();
  });

  test(&#39;create a user&#39;, function () {
    const returnedUser = donationService.createUser(newUser);
    assert(_.some([returnedUser], newUser), &#39;returnedUser must be a superset of newUser&#39;);
    assert.isDefined(returnedUser._id);
  });

  test(&#39;get user&#39;, function () {
    const u1 = donationService.createUser(newUser);
    const u2 = donationService.getUser(u1._id);
    assert.deepEqual(u1, u2);
  });

  test(&#39;get invalid user&#39;, function () {
    const u1 = donationService.getUser(&#39;1234&#39;);
    assert.isNull(u1);
    const u2 = donationService.getUser(&#39;012345678901234567890123&#39;);
    assert.isNull(u2);
  });

  test(&#39;delete a user&#39;, function () {
    const u = donationService.createUser(newUser);
    assert(donationService.getUser(u._id) != null);
    donationService.deleteOneUser(u._id);
    assert(donationService.getUser(u._id) == null);
  });

  test(&#39;get all users&#39;, function () {
    for (let u of users) {
      donationService.createUser(u);
    }

    const allUsers = donationService.getUsers();
    assert.equal(allUsers.length, users.length);
  });

  test(&#39;get users detail&#39;, function () {
    for (let u of users) {
      donationService.createUser(u);
    }

    const allUsers = donationService.getUsers();
    for (var i = 0; i &lt; users.length; i++) {
      assert(_.some([allUsers[i]], users[i]), &#39;returnedUser must be a superset of newUser&#39;);
    }
  });

  test(&#39;get all users empty&#39;, function () {
    const allUsers = donationService.getUsers();
    assert.equal(allUsers.length, 0);
  });
});</code></pre>
<h2>candidatesapitest.js</h2>
<pre><code>  const donationService = new DonationService(fixtures.donationService);</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="02">
        <h1>Retrieve All Donations API</h1>
<p>Currently our api only supports candidate and user model access/update. What about donations?</p>
<p>We start with just retrieving donations:</p>
<h2>routesapi.js</h2>
<pre><code>...
const DonationsApi = require(&#39;./app/api/donationsapi&#39;);
...

  { method: &#39;GET&#39;, path: &#39;/api/donations&#39;, config: DonationsApi.findAllDonations },
...</code></pre>
<h2>api/donationsapi.js</h2>
<pre><code>&#39;use strict&#39;;

const Donation = require(&#39;../models/donation&#39;);
const Boom = require(&#39;boom&#39;);

exports.findAllDonations = {

  auth: false,

  handler: function (request, reply) {
    Donation.find({}).populate(&#39;donor&#39;).populate(&#39;candidate&#39;).then(donations =&gt; {
      reply(donations);
    }).catch(err =&gt; {
      reply(Boom.badImplementation(&#39;error accessing db&#39;));
    });
  },
};</code></pre>
<p>We can use either a browser or postman to test this route:</p>
<ul>
<li><a href="http://localhost:4000/api/donations">http://localhost:4000/api/donations</a></li>
</ul>
<p><img src="img/01.png" alt=""></p>
<p>We are retrieving the seeded donations in the above.</p>
<p>It would be useful to write a test for this route also, but as we cannot yet make a donation the test will be of limited value. We will come back to this as soon as we figure out how making donations can be supported.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>Retrieving donations for a Candidate</h1>
<p>Donations are associated with candidates and donors. Using REST principles we imagine a simple path that could yield donations for a specific candidate:</p>
<ul>
<li><a href="http://localhost:4000/api/candidates/012345678901234567890123/donations">http://localhost:4000/api/candidates/012345678901234567890123/donations</a></li>
</ul>
<p>This could retrieve all donations for the candidate with the ID provided in the url.</p>
<p>This is the implementation:</p>
<h2>routesapi.js</h2>
<pre><code>  { method: &#39;GET&#39;, path: &#39;/api/candidates/{id}/donations&#39;, config: DonationsApi.findDonations },</code></pre>
<h2>donationsapi.js</h2>
<pre><code>exports.findDonations = {

  auth: false,

  handler: function (request, reply) {
    Donation.find({ candidate: request.params.id }).then(donations =&gt; {
      reply(donations);
    }).catch(err =&gt; {
      reply(Boom.badImplementation(&#39;error accessing db&#39;));
    });
  },

};</code></pre>
<p>We can test using the browser (on the seeded data):</p>
<p><img src="img/02.png" alt=""></p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>Creating &amp; Deleting Donations</h1>
<p>Creating a donation, and associating it with a candidate, can be implemented using a similar pattern to retrieving donations for a candidate:</p>
<h2>routesapi.js</h2>
<pre><code>  { method: &#39;POST&#39;, path: &#39;/api/candidates/{id}/donations&#39;, config: DonationsApi.makeDonation },</code></pre>
<p>We can define a route to delete all donations:</p>
<pre><code>  { method: &#39;DELETE&#39;, path: &#39;/api/donations&#39;, config: DonationsApi.deleteAllDonations },</code></pre>
<p>These are the implementations:</p>
<h2>app/api/donationsapi.js</h2>
<pre><code>exports.makeDonation = {

  auth: false,

  handler: function (request, reply) {
    const donation = new Donation(request.payload);
    donation.candidate = request.params.id;
    donation.save().then(newDonation =&gt; {
      reply(newDonation).code(201);
    }).catch(err =&gt; {
      reply(Boom.badImplementation(&#39;error making donation&#39;));
    });
  },

};

exports.deleteAllDonations = {

  auth: false,

  handler: function (request, reply) {
    Donation.remove({}).then(err =&gt; {
      reply().code(204);
    }).catch(err =&gt; {
      reply(Boom.badImplementation(&#39;error removing Donations&#39;));
    });
  },

};</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="05">
        <h1>Preparing to test the Donations API</h1>
<p>We can extend the fixtures.json to include some donation objects for test purposes:</p>
<h2>test/fixtures.json</h2>
<pre><code>...
  &quot;donations&quot;: [
    {
      &quot;amount&quot;: 40,
      &quot;method&quot;: &quot;paypal&quot;
    },
    {
      &quot;amount&quot;: 90,
      &quot;method&quot;: &quot;direct&quot;
    },
    {
      &quot;amount&quot;: 430,
      &quot;method&quot;: &quot;paypal&quot;
    }
  ],
...</code></pre>
<p>And then we can start to scaffold up our tests. They have a common structure:</p>
<h2>test/donationsapitest.js</h2>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const _ = require(&#39;lodash&#39;);

suite(&#39;Donation API tests&#39;, function () {

  let donations = fixtures.donations;
  let newCandidate = fixtures.newCandidate;

  const donationService = new DonationService(fixtures.donationService);

  beforeEach(function () {
  });

  afterEach(function () {

  });

  test(&#39;a test function&#39;, function () {

  });

});</code></pre>
<p>Before composing the tests, we need to extend <code>DonationService</code> to support additional features:</p>
<h2>donation-service.js</h2>
<pre><code>  makeDonation(id, donation) {
    return this.httpService.post(&#39;/api/candidates/&#39; + id + &#39;/donations&#39;, donation);
  }

  getDonations(id) {
    return this.httpService.get(&#39;/api/candidates/&#39; + id + &#39;/donations&#39;);
  }

  deleteAllDonations() {
    return this.httpService.delete(&#39;/api/donations&#39;);
  }</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="06">
        <h1>Donations API Tests</h1>
<p>Here are a first set of tests:</p>
<h2>test/donationsapitest.js</h2>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const _ = require(&#39;lodash&#39;);

suite(&#39;Donation API tests&#39;, function () {

  let donations = fixtures.donations;
  let newCandidate = fixtures.newCandidate;

  const donationService = new DonationService(&#39;http://localhost:4000&#39;);

  beforeEach(function () {
    donationService.deleteAllCandidates();
    donationService.deleteAllDonations();
  });

  afterEach(function () {
    donationService.deleteAllCandidates();
    donationService.deleteAllDonations();
  });

  test(&#39;create a donation&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    donationService.makeDonation(returnedCandidate._id, donations[0]);
    const returnedDonations = donationService.getDonations(returnedCandidate._id);
    assert.equal(returnedDonations.length, 1);
    assert(_.some([returnedDonations[0]], donations[0]), &#39;returned donation must be a superset of donation&#39;);
  });

  test(&#39;create multiple donations&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    for (var i = 0; i &lt; donations.length; i++) {
      donationService.makeDonation(returnedCandidate._id, donations[i]);
    }

    const returnedDonations = donationService.getDonations(returnedCandidate._id);
    assert.equal(returnedDonations.length, donations.length);
    for (var i = 0; i &lt; donations.length; i++) {
      assert(_.some([returnedDonations[i]], donations[i]), &#39;returned donation must be a superset of donation&#39;);
    }
  });

  test(&#39;delete all donations&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    for (var i = 0; i &lt; donations.length; i++) {
      donationService.makeDonation(returnedCandidate._id, donations[i]);
    }

    const d1 = donationService.getDonations(returnedCandidate._id);
    assert.equal(d1.length, donations.length);
    donationService.deleteAllDonations();
    const d2 = donationService.getDonations(returnedCandidate._id);
    assert.equal(d2.length, 0);
  });
});</code></pre>
<p>These tests should run successfully now.</p>
<p>We now have a comprehensive set of tests:</p>
<p><img src="img/03.png" alt=""></p>
<p>In the above, all the tests have been run collectively via a <code>test file pattern</code> configuration:</p>
<p><img src="img/04.png" alt=""></p>
<p>You should be able to reproduce this in your IDE.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="07.Exercises">
        <h1>Exercises</h1>
<h2>Exercise 1: Delete Donations for a Candidate</h2>
<p>Introduce a route to support deleting of donations for a single candidate.</p>
<h2>Exercise 2: Test Delete Donations</h2>
<p>Write unit tests to exercise the new delete donations feature.</p>
<h2>Exercise 3: Donor Support</h2>
<p>Currently we leave the <code>donor</code> property of each donation empty, at least when using the api. This is clearly incomplete, as donor are faithfully recorded if the Web UI is engaged.</p>
<ul>
<li>How is the donor identified via the Web UI?</li>
<li>How might we record donors using the API? </li>
</ul>

      </div>
     
    </div>
  </div>
</div>
<!--<div class="ui bottom fixed borderless right menu">
  <div class="ui right tiny menu">
    <div class="ui mini message segment">
      .
      <a href="http://creativecommons.org/licenses/by-nc/4.0/"
         title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
         target="_blank">Creative Commons License
      </a>
    </div>
  </div>
</div>-->

<script>
  $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

</script>



    <footer>

    </footer>
    <script>
      $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>