 <!DOCTYPE html>
 <html>
   <head>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

     

     <style>
       

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}



     </style>

   </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom:thin solid black;
}

h2
{
  font-size:110%;
  border-bottom: thin solid black;
}

h3
{
  font-size:100%;
  border-bottom: thin solid black;
}

body
{
  overflow-y: scroll;
}

.pushable > .pusher
{
  padding-bottom: 1.5rem;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}



</style>

<div class="ui fixed top pointing inverted stackable menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      24: Aurelia Routers
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="Lab-Aurelia 3">
      Lab-Aurelia 3
    </a>
    
    <a class="item" data-tab="Exercise Solutions 1">
      Exercise Solutions 1
    </a>
    
    <a class="item" data-tab="Exercise Solution 2">
      Exercise Solution 2
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" data-tab="05">
      05
    </a>
    
    <a class="item" data-tab="06">
      06
    </a>
    
    <a class="item" data-tab="07.Exercises">
      07.Exercises
    </a>
    
    <div class="item">
      
    </div>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    <br><br>
    
      
        <a class="item" href="../../topic-02-js-review/book-1-javascript-intro/index.html">
          Lab-2.1 JS Intro
        </a>
      
    
      
        <a class="item" href="../../topic-02-js-review/book-2-javascript-fundamentals/index.html">
          Lab-2.2 JS Basics
        </a>
      
    
      
        <a class="item" href="../../topic-03-jquery+dom/book-3-jquery/index.html">
          Lab-3 JQuery
        </a>
      
    
      
        <a class="item" href="../../topic-04-ajax+apis/book-1-ajax-1/index.html">
          Lab-4.1 Github API
        </a>
      
    
      
        <a class="item" href="../../topic-04-ajax+apis/book-2-ajax-2/index.html">
          Lab-4.2-FoureSquare API
        </a>
      
    
      
        <a class="item" href="../../topic-05-applications/book-applications/index.html">
          Lab-5 Applications
        </a>
      
    
      
        <a class="item" href="../../topic-06-views/book-views/index.html">
          Lab-6 Views
        </a>
      
    
      
        <a class="item" href="../../topic-07-sessions/book-sessions/index.html">
          Lab-7 Sessions
        </a>
      
    
      
        <a class="item" href="../../topic-08-models/book-models/index.html">
          Lab-8 Models
        </a>
      
    
      
        <a class="item" href="../../topic-09-validation/book-validation/index.html">
          Lab-9 Validation
        </a>
      
    
      
        <a class="item" href="../../topic-10-deployment/book-deployment/index.html">
          Lab-10 Deployment
        </a>
      
    
      
        <a class="item" href="../../topic-11-seeding/book-seeding/index.html">
          Lab-11 Seeding
        </a>
      
    
      
        <a class="item" href="../../topic-12-api/book-api/index.html">
          Lab-12 Apis
        </a>
      
    
      
        <a class="item" href="../../topic-13-security-introduction/book-1-pgp-gpg/index.html">
          Lab-13 GPG
        </a>
      
    
      
        <a class="item" href="../../topic-14-security-foundations/book-1-openssl/index.html">
          Lab-14 OpenSSL and Certificates
        </a>
      
    
      
        <a class="item" href="../../topic-15-authentication+tls/book-1-tls-configuration/index.html">
          Lab-15 TLS Configuration
        </a>
      
    
      
        <a class="item" href="../../topic-16-tdd/book-tdd/index.html">
          Lab-16 Tdd
        </a>
      
    
      
        <a class="item" href="../../topic-17-webapp-threats+vulnerabilities/book-1-misuse-cases/index.html">
          Lab-17 Misuse Cases
        </a>
      
    
      
        <a class="item" href="../../topic-18-rest/book-rest/index.html">
          Lab-18 Rest
        </a>
      
    
      
        <a class="item" href="../../topic-19-web-app-authentication/book-1-web-authentication/index.html">
          Lab-19 Authentication techniques
        </a>
      
    
      
        <a class="item" href="../../topic-20-rest-client/book-rest-client/index.html">
          Lab-19 Java Rest Client
        </a>
      
    
      
        <a class="item" href="../../topic-21-aurelia-1/book-aurelia-1/index.html">
          Lab-Aurelia 1
        </a>
      
    
      
        <a class="item" href="../../topic-22-pentesting/book-1-burp-proxy/index.html">
          Lab-Burp-Proxy
        </a>
      
    
      
        <a class="item" href="../../topic-22-pentesting/book-2-regex/index.html">
          Regular Expressions
        </a>
      
    
      
        <a class="item" href="../../topic-22-pentesting/book-3-xss/index.html">
          XSS tips
        </a>
      
    
      
        <a class="item" href="../../topic-23-aurelia-2/book-aurelia-2/index.html">
          Lab-Aurelia 2
        </a>
      
    
      
        <a class="active item" href="../../topic-24-aurelia-3/book-aurelia-3/index.html">
          Lab-Aurelia 3
        </a>
      
    
      
        <a class="item" href="../../topic-24-aurelia-3/book-aurelia-3-ts/index.html">
          Aurelia Lab 3 TS
        </a>
      
    
      
        <a class="item" href="../../topic-25-aurelia-4/book-aurelia-4/index.html">
          Lab-Aurelia 4
        </a>
      
    
      
        <a class="item" href="../../topic-25-aurelia-4/book-aurelia-ts-4/index.html">
          Lab-Aurelia 4 TS
        </a>
      
    
      
        <a class="item" href="../../topic-26-aurelia-5/book-a-hapi-auth/index.html">
          Lab-Hapi-JWT
        </a>
      
    
      
        <a class="item" href="../../topic-26-aurelia-5/book-b-aurelia-5/index.html">
          Lab-Aurelia 5
        </a>
      
    
  </div>
  <div class="pusher" tabindex="-1">
    <div class="ui basic segment" id="labchat">
      <br>
      
      <div  class="ui tab segment lab" data-tab="Lab-Aurelia 3">
        <h1>Objectives</h1>
<p>Incorporate aurelia routers into donation-client. This will enable a more orderly evolution of the application, allowing new viewmodels to be introduced in a consistent manner.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Exercise Solutions 1">
        <h1>Lab Aurelia 2 Exercise 1: Login Feature in DonationService</h1>
<p>Implement in <code>DonationService</code> a login feature, which checks the username/password against the fixtures we have already loaded in this class. Only allow the user to progress to logged in status if there is a valid entry</p>
<h2>Solution</h2>
<p>First incorporate some users into the fixtures:</p>
<h2>app/services/fixtures.js</h2>
<pre><code>  users = {
    &#39;homer@simpson.com&#39;: {
      firstName: &#39;Homer&#39;,
      lastName: &#39;Simpson&#39;,
      email: &#39;homer@simpson.com&#39;,
      password: &#39;secret&#39;
    },
    &#39;marge@simpson.com&#39;: {
      firstName: &#39;Marge&#39;,
      lastName: &#39;Simpson&#39;,
      email: &#39;marge@simpson.com&#39;,
      password: &#39;secret&#39;
    }
  }</code></pre>
<p>.. and load them in our service:</p>
<pre><code>...
export default class DonationService {

  ...
  users = [];  
  ...

  constructor(data, ea) {
    this.users = data.users;
    ...
  }
  ...</code></pre>
<p>Introduce this new method in DonationService:</p>
<h2>src/services/donation-service.js</h2>
<pre><code>  login(email, password) {
    const status = {
      success: false,
      message: &#39;&#39;
    };

    if (this.users[email]) {
      if (this.users[email].password === password) {
        status.success = true;
        status.message = &#39;logged in&#39;;
      } else {
        status.message = &#39;Incorrect password&#39;;
      }
    } else {
      status.message = &#39;Unknown user&#39;;
    }

    return status;
  }</code></pre>
<p>app.js can now be revised to use this method. This involves injecting the donation-service into the App, and refactoring login method:</p>
<h2>src/app.js</h2>
<pre><code>import {inject} from &#39;aurelia-framework&#39;;
import DonationService from &#39;./services/donation-service&#39;;

@inject(DonationService)
export class App {

  email = &#39;marge@simpson.com&#39;;
  password = &#39;secret&#39;;

  loggedIn = false;

  constructor(ds) {
    this.donationService = ds;
  }

  login(e) {
    console.log(`Trying to log in ${this.email}`);
    const status = this.donationService.login(this.email, this.password);
    this.prompt = status.message;
    this.loggedIn = status.success;
  }

  logout() {
    console.log(&#39;Logging out`&#39;);
    this.loggedIn = false;
  }
}</code></pre>
<p>Run the app now, and experiment with various valid and invalid credentials. Notice how the validation error messages are displayed.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Exercise Solution 2">
        <h1>Lab Aurelia 2 Exercise 2: Signup UI + Feature</h1>
<p>Implement a signup viewmodel, which will add a user to the <code>DonationService</code> users array. This view should be visible when the user presses a &#39;signup&#39; option on the menu. This will take some work, as we want either the login view OR the signup view to appear. Subsequently, once logged in, we wish neither view to be visible.</p>
<h2>src/viewmodels/signup.html</h2>
<pre><code>&lt;template&gt;
  &lt;form submit.delegate=&quot;register($event)&quot; class=&quot;ui stacked segment form&quot;&gt;
    &lt;h3 class=&quot;ui header&quot;&gt;Register&lt;/h3&gt;
    &lt;div class=&quot;two fields&quot;&gt;
      &lt;div class=&quot;field&quot;&gt;
        &lt;label&gt;First Name&lt;/label&gt;
        &lt;input placeholder=&quot;First Name&quot; type=&quot;text&quot; value.bind=&quot;firstName&quot;&gt;
      &lt;/div&gt;
      &lt;div class=&quot;field&quot;&gt;
        &lt;label&gt;Last Name&lt;/label&gt;
        &lt;input placeholder=&quot;Last Name&quot; type=&quot;text&quot; value.bind=&quot;lastName&quot;&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;Email&lt;/label&gt;
      &lt;input placeholder=&quot;Email&quot; type=&quot;text&quot; value.bind=&quot;email&quot;&gt;
    &lt;/div&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;Password&lt;/label&gt;
      &lt;input type=&quot;password&quot; value.bind=&quot;password&quot;&gt;
    &lt;/div&gt;
    &lt;button class=&quot;ui blue submit button&quot;&gt;Submit&lt;/button&gt;
  &lt;/form&gt;
&lt;/template&gt;</code></pre>
<h2>src/services/donation-service.js</h2>
<pre><code>  register(firstName, lastName, email, password) {
    const newUser = {
      firstName: firstName,
      lastName: lastName,
      email: email,
      password: password
    };
    this.users[email] = newUser;
  }</code></pre>
<h2>src/app.html</h2>
<pre><code>&lt;template&gt;

  &lt;div class=&quot;ui container&quot;&gt;

    &lt;nav class=&quot;ui inverted menu&quot;&gt;
      &lt;header class=&quot;header item&quot;&gt;&lt;a href=&quot;/&quot;&gt; Donation &lt;/a&gt;&lt;/header&gt;
      &lt;div class=&quot;right menu&quot;&gt;
        &lt;div show.bind=&quot;!loggedIn&quot;&gt;
          &lt;a class=&quot;item&quot; click.trigger=&quot;signup()&quot;&gt; Signup &lt;/a&gt;
        &lt;/div&gt;
        &lt;div show.bind=&quot;loggedIn&quot;&gt;
          &lt;a class=&quot;item&quot; click.trigger=&quot;logout()&quot;&gt; Logout &lt;/a&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/nav&gt;

    &lt;section class=&quot;ui four column stackable grid basic segment&quot;&gt;
      &lt;div show.bind=&quot;!loggedIn&quot; class=&quot;ui row&quot;&gt;
        &lt;div show.bind=&quot;!showSignup&quot; class=&quot;ui row&quot;&gt;
          &lt;section class=&quot;ui five wide column&quot;&gt;
            &lt;compose view=&quot;./viewmodels/login.html&quot;&gt;&lt;/compose&gt;
          &lt;/section&gt;
        &lt;/div&gt;
        &lt;div show.bind=&quot;showSignup&quot; class=&quot;ui row&quot;&gt;
          &lt;section class=&quot;ui five wide column&quot;&gt;
            &lt;compose view=&quot;./viewmodels/signup.html&quot;&gt;&lt;/compose&gt;
          &lt;/section&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div show.bind=&quot;loggedIn&quot; class=&quot;ui row&quot;&gt;
        &lt;aside class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/donate&quot;&gt;&lt;/compose&gt;
        &lt;/aside&gt;
        &lt;article class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/report&quot;&gt;&lt;/compose&gt;
        &lt;/article&gt;
        &lt;article class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/candidates&quot;&gt;&lt;/compose&gt;
        &lt;/article&gt;
        &lt;article class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/stats&quot;&gt;&lt;/compose&gt;
        &lt;/article&gt;
      &lt;/div&gt;
    &lt;/section&gt;
  &lt;/div&gt;

&lt;/template&gt;</code></pre>
<h2>src/app.js</h2>
<pre><code>import {inject} from &#39;aurelia-framework&#39;;
import DonationService from &#39;./services/donation-service&#39;;

@inject(DonationService)
export class App {

  firstName = &#39;Marge&#39;;
  lastName = &#39;Simpson&#39;;
  email = &#39;marge@simpson.com&#39;;
  password = &#39;secret&#39;;

  loggedIn = false;
  showSignup = false;

  constructor(ds) {
    this.donationService = ds;
  }

  signup() {
    this.showSignup = true;
  }

  register(e) {
    this.showSignup = false;
    this.donationService.register(this.firstName, this.lastName, this.email, this.password);
  }

  login(e) {
    console.log(`Trying to log in ${this.email}`);
    const status = this.donationService.login(this.email, this.password);
    this.prompt = status.message;
    this.loggedIn = status.success;
  }

  logout() {
    console.log(&#39;Logging out`&#39;);
    this.loggedIn = false;
  }
}</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>Viewmodels</h1>
<p>We will now restructure the <code>viewmodels</code> folder, encapsulating each view/viewmodel in its own directory like this:</p>
<p><img src="img/01.png" alt=""></p>
<p>The logged in element in <code>app.html</code> will need to reflect the changed paths:</p>
<pre><code>    ...
      &lt;div show.bind=&quot;loggedIn&quot; class=&quot;ui row&quot;&gt;
        &lt;aside class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/donate/donate&quot;&gt;&lt;/compose&gt;
        &lt;/aside&gt;
        &lt;article class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/report/report&quot;&gt;&lt;/compose&gt;
        &lt;/article&gt;
        &lt;article class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/candidates/candidates&quot;&gt;&lt;/compose&gt;
        &lt;/article&gt;
        &lt;article class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/stats/stats&quot;&gt;&lt;/compose&gt;
        &lt;/article&gt;
      &lt;/div&gt;
    ...</code></pre>
<p>Verify that everything works before proceeding to the next steps (make sure the import paths within each viewmodel are adjusted appropriately)</p>
<p>Notice that signup and login are views without viewmodels. Before we bring in these, introduce this new message class:</p>
<h2>src/services/messages.js</h2>
<pre><code>...

export class LoginStatus {
  constructor(status) {
    this.status = status;
  }
}</code></pre>
<p>Now bring in the viewmodels for login &amp; signup:</p>
<h2>src/viewmodels/login/login.js</h2>
<pre><code>import {inject} from &#39;aurelia-framework&#39;;
import {EventAggregator} from &#39;aurelia-event-aggregator&#39;;
import DonationService from &#39;../../services/donation-service&#39;;
import {LoginStatus} from &#39;../../services/messages&#39;;

@inject(EventAggregator, DonationService)
export class Login {

  email = &#39;marge@simpson.com&#39;;
  password = &#39;secret&#39;;

  constructor(ea, ds) {
    this.ea = ea;
    this.donationService = ds;
    this.prompt = &#39;&#39;;
  }

  login(e) {
    console.log(`Trying to log in ${this.email}`);
    const status = this.donationService.login(this.email, this.password);
    this.ea.publish(new LoginStatus(status));
  }
}</code></pre>
<h2>src/viewmodels/signup/signup.js</h2>
<pre><code>import {inject} from &#39;aurelia-framework&#39;;
import {EventAggregator} from &#39;aurelia-event-aggregator&#39;;
import DonationService from &#39;../../services/donation-service&#39;;
import {LoginStatus} from &#39;../../services/messages&#39;;

@inject(EventAggregator, DonationService)
export class Signup {

  firstName = &#39;Marge&#39;;
  lastName = &#39;Simpson&#39;;
  email = &#39;marge@simpson.com&#39;;
  password = &#39;secret&#39;;

  constructor(ea, ds) {
    this.ea = ea;
    this.donationService = ds;
  }

  register(e) {
    this.showSignup = false;
    this.donationService.register(this.firstName, this.lastName, this.email, this.password);
    const status = this.donationService.login(this.email, this.password);
    this.ea.publish(new LoginStatus(status));
  }
}</code></pre>
<p>And this is the revised <code>app</code> viewmodel + view:</p>
<h2>/src/app.js</h2>
<pre><code>import {inject} from &#39;aurelia-framework&#39;;
import {EventAggregator} from &#39;aurelia-event-aggregator&#39;;
import DonationService from &#39;./services/donation-service&#39;;
import {LoginStatus} from &#39;./services/messages&#39;;

@inject(EventAggregator, DonationService)
export class App {

  loggedIn = false;
  showSignup = false;

  constructor(ea, ds) {
    this.donationService = ds;
    ea.subscribe(LoginStatus, msg =&gt; {
      this.loggedIn = msg.status.success;
    });
  }

  signup() {
    this.showSignup = true;
  }

  logout() {
    console.log(&#39;Logging out`&#39;);
    this.loggedIn = false;
  }
}</code></pre>
<h2>src/app.html</h2>
<pre><code>&lt;template&gt;

  &lt;div class=&quot;ui container&quot;&gt;

    &lt;nav class=&quot;ui inverted menu&quot;&gt;
      &lt;header class=&quot;header item&quot;&gt;&lt;a href=&quot;/&quot;&gt; Donation &lt;/a&gt;&lt;/header&gt;
      &lt;div class=&quot;right menu&quot;&gt;
        &lt;div show.bind=&quot;!loggedIn&quot;&gt;
          &lt;a class=&quot;item&quot; click.trigger=&quot;signup()&quot;&gt; Signup &lt;/a&gt;
        &lt;/div&gt;
        &lt;div show.bind=&quot;loggedIn&quot;&gt;
          &lt;a class=&quot;item&quot; click.trigger=&quot;logout()&quot;&gt; Logout &lt;/a&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/nav&gt;

    &lt;section class=&quot;ui four column stackable grid basic segment&quot;&gt;
      &lt;div show.bind=&quot;!loggedIn&quot; class=&quot;ui row&quot;&gt;
        &lt;div show.bind=&quot;!showSignup&quot; class=&quot;ui row&quot;&gt;
          &lt;section class=&quot;ui five wide column&quot;&gt;
            &lt;compose view-model=&quot;./viewmodels/login/login&quot;&gt;&lt;/compose&gt;
          &lt;/section&gt;
        &lt;/div&gt;
        &lt;div show.bind=&quot;showSignup&quot; class=&quot;ui row&quot;&gt;
          &lt;section class=&quot;ui five wide column&quot;&gt;
            &lt;compose view-model=&quot;./viewmodels/signup/signup&quot;&gt;&lt;/compose&gt;
          &lt;/section&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div show.bind=&quot;loggedIn&quot; class=&quot;ui row&quot;&gt;
        &lt;aside class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/donate/donate&quot;&gt;&lt;/compose&gt;
        &lt;/aside&gt;
        &lt;article class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/report/report&quot;&gt;&lt;/compose&gt;
        &lt;/article&gt;
        &lt;article class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/candidates/candidates&quot;&gt;&lt;/compose&gt;
        &lt;/article&gt;
        &lt;article class=&quot;column&quot;&gt;
          &lt;compose view-model=&quot;./viewmodels/stats/stats&quot;&gt;&lt;/compose&gt;
        &lt;/article&gt;
      &lt;/div&gt;
    &lt;/section&gt;
  &lt;/div&gt;

&lt;/template&gt;</code></pre>
<p>Get all this working now. Study carefully the login, app and signup viewmodels. Notice how they are communicating via the event aggregator - and the message <code>LoginStatus</code>. See if you can follow the flow control. Remember, you can place breakpoints in the source (via Chrome developer tools) and follow this more closely.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>EventAggregation</h1>
<p>Currently, our use of the EventAggregator is a little haphazard. This is a revised version of the donation-service object:</p>
<h2>src/services/donation-service.js</h2>
<pre><code>import {inject} from &#39;aurelia-framework&#39;;
import Fixtures from &#39;./fixtures&#39;;
import {TotalUpdate, LoginStatus} from &#39;./messages&#39;;
import {EventAggregator} from &#39;aurelia-event-aggregator&#39;;

@inject(Fixtures, EventAggregator)
export default class DonationService {

  donations = [];
  methods = [];
  candidates = [];
  users = [];
  total = 0;

  constructor(data, ea) {
    this.users = data.users;
    this.donations = data.donations;
    this.candidates = data.candidates;
    this.methods = data.methods;
    this.ea = ea;
  }

  donate(amount, method, candidate) {
    const donation = {
      amount: amount,
      method: method,
      candidate: candidate
    };
    this.donations.push(donation);
    console.log(amount + &#39; donated to &#39; + candidate.firstName + &#39; &#39; + candidate.lastName + &#39;: &#39; + method);

    this.total = this.total + parseInt(amount, 10);
    console.log(&#39;Total so far &#39; + this.total);
    this.ea.publish(new TotalUpdate(this.total));
  }

  addCandidate(firstName, lastName, office) {
    const candidate = {
      firstName: firstName,
      lastName: lastName,
      office: office
    };
    this.candidates.push(candidate);
  }

  register(firstName, lastName, email, password) {
    const newUser = {
      firstName: firstName,
      lastName: lastName,
      email: email,
      password: password
    };
    this.users[email] = newUser;
  }

  login(email, password) {
    const status = {
      success: false,
      message: &#39;&#39;
    };

    if (this.users[email]) {
      if (this.users[email].password === password) {
        status.success = true;
        status.message = &#39;logged in&#39;;
      } else {
        status.message = &#39;Incorrect password&#39;;
      }
    } else {
      status.message = &#39;Unknown user&#39;;
    }
    this.ea.publish(new LoginStatus(status));
  }

  logout() {
    const status = {
      success: false,
      message: &#39;&#39;
    };
    this.ea.publish(new LoginStatus(status));
  }
}</code></pre>
<p>It has the following small updates:</p>
<ul>
<li><p>the login method no longer returns a <code>success</code> object - but publish as equivalent <code>LoginStatus</code> object on the event system</p>
</li>
<li><p>a new logout methods, which also publishes an appropriate event.</p>
</li>
</ul>
<p>Login and Signup viewmodels can be updated and simplified:</p>
<h2>src/viewmodels/login/login.js</h2>
<pre><code>import {inject} from &#39;aurelia-framework&#39;;
import DonationService from &#39;../../services/donation-service&#39;;

@inject(DonationService)
export class Login {

  email = &#39;marge@simpson.com&#39;;
  password = &#39;secret&#39;;

  constructor(ds) {
    this.donationService = ds;
    this.prompt = &#39;&#39;;
  }

  login(e) {
    console.log(`Trying to log in ${this.email}`);
    this.donationService.login(this.email, this.password);
  }
}</code></pre>
<h2>src/viewmodels/signup/signup.js</h2>
<pre><code>import {inject} from &#39;aurelia-framework&#39;;
import DonationService from &#39;../../services/donation-service&#39;;

@inject(DonationService)
export class Signup {

  firstName = &#39;Marge&#39;;
  lastName = &#39;Simpson&#39;;
  email = &#39;marge@simpson.com&#39;;
  password = &#39;secret&#39;;

  constructor(ds) {
    this.donationService = ds;
  }

  register(e) {
    this.showSignup = false;
    this.donationService.register(this.firstName, this.lastName, this.email, this.password);
    this.donationService.login(this.email, this.password);
  }
}</code></pre>
<p>With this simplification in place, we can move on to a revised approach to the application architecture.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="05">
        <h1>Routers</h1>
<p>We can significantly revise the approach we have taken to date - particularly the complex relationship between the various views the app viewmodel is displaying.</p>
<p>This is implemented via client side routers. These routes will be driven by a menu bar, not unlike our menus on the service rendered application.</p>
<p>First introduce the following menu bar template:</p>
<h2>src/nav-bar.html</h2>
<pre><code>&lt;template bindable=&quot;router&quot;&gt;
  &lt;nav class=&quot;ui inverted menu&quot;&gt;
    &lt;header class=&quot;header item&quot;&gt;&lt;a href=&quot;/&quot;&gt; Donation &lt;/a&gt;&lt;/header&gt;
    &lt;div class=&quot;right menu&quot;&gt;
      &lt;div repeat.for=&quot;row of router.navigation&quot;&gt;
        &lt;a class=&quot;${row.isActive ? &#39;active&#39; : &#39;&#39;} item&quot;  href.bind=&quot;row.href&quot;&gt;${row.title}&lt;/a&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/nav&gt;
&lt;/template&gt;</code></pre>
<p>The App viewmodel can not be restructure as follows:</p>
<h2>src/app.js</h2>
<pre><code>import {inject, Aurelia} from &#39;aurelia-framework&#39;;
import {EventAggregator} from &#39;aurelia-event-aggregator&#39;;
import {LoginStatus} from &#39;./services/messages&#39;;

@inject(Aurelia, EventAggregator)
export class App {

  constructor(au, ea) {
    ea.subscribe(LoginStatus, msg =&gt; {
      if (msg.status.success === true) {
        au.setRoot(&#39;home&#39;).then(() =&gt; {
          this.router.navigateToRoute(&#39;donate&#39;);
        });
      } else {
        au.setRoot(&#39;app&#39;).then(() =&gt; {
          this.router.navigateToRoute(&#39;login&#39;);
        });
      }
    });
  }

  configureRouter(config, router) {
    config.map([
      { route: [&#39;&#39;, &#39;login&#39;], name: &#39;login&#39;, moduleId: &#39;viewmodels/login/login&#39;, nav: true, title: &#39;Login&#39; },
      { route: &#39;signup&#39;, name: &#39;signup&#39;, moduleId: &#39;viewmodels/signup/signup&#39;, nav: true, title: &#39;Signup&#39; }
    ]);
    this.router = router;
  }
}</code></pre>
<h2>src/app.html</h2>
<pre><code>&lt;template&gt;
  &lt;require from=&quot;nav-bar.html&quot;&gt;&lt;/require&gt;
  &lt;div class=&quot;ui container page-host&quot;&gt;
    &lt;nav-bar router.bind=&quot;router&quot;&gt;&lt;/nav-bar&gt;
    &lt;router-view&gt;&lt;/router-view&gt;
  &lt;/div&gt;
&lt;/template&gt;</code></pre>
<p>This viewmodel will trigger - on login - another router, manged my another view/viewmodel. This is it here:</p>
<h2>src/home.js</h2>
<pre><code>import { inject, Aurelia } from &#39;aurelia-framework&#39;;

@inject(Aurelia)
export class Home {

  constructor(au) {
    this.aurelia = au;
  }

  configureRouter(config, router) {
    config.map([
      { route: [&#39;&#39;, &#39;home&#39;], name: &#39;donate&#39;, moduleId: &#39;viewmodels/donate/donate&#39;, nav: true, title: &#39;Donate&#39; },
      { route: &#39;report&#39;, name: &#39;report&#39;, moduleId: &#39;viewmodels/report/report&#39;, nav: true, title: &#39;Report&#39; },
      { route: &#39;candidates&#39;, name: &#39;candidates&#39;, moduleId: &#39;viewmodels/candidates/candidates&#39;, nav: true, title: &#39;Candidates&#39; },
      { route: &#39;stats&#39;, name: &#39;stats&#39;, moduleId: &#39;viewmodels/stats/stats&#39;, nav: true, title: &#39;Stats&#39; },
      { route: &#39;logout&#39;, name: &#39;logout&#39;, moduleId: &#39;viewmodels/logout/logout&#39;, nav: true, title: &#39;Logout&#39; }
    ]);
    this.router = router;

    config.mapUnknownRoutes(instruction =&gt; {
      return &#39;home&#39;;
    });
  }
}</code></pre>
<h2>src/home.html</h2>
<pre><code>&lt;template&gt;
  &lt;require from=&quot;nav-bar.html&quot;&gt;&lt;/require&gt;
  &lt;div class=&quot;ui container page-host&quot;&gt;
    &lt;nav-bar router.bind=&quot;router&quot;&gt;&lt;/nav-bar&gt;
    &lt;router-view&gt;&lt;/router-view&gt;
  &lt;/div&gt;
&lt;/template&gt;</code></pre>
<p>Run the app now - and see how it performs. In particular, pay close attention to the constructor of the app viewmodel:</p>
<pre><code>  constructor(au, ea) {
    ea.subscribe(LoginStatus, msg =&gt; {
      if (msg.status.success === true) {
        au.setRoot(&#39;home&#39;).then(() =&gt; {
          this.router.navigateToRoute(&#39;donate&#39;);
        });
      } else {
        au.setRoot(&#39;app&#39;).then(() =&gt; {
          this.router.navigateToRoute(&#39;login&#39;);
        });
      }
    });
  }</code></pre>
<p>Can you see what it going on here? Try to relate it to the login viewmodel behavior.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="06">
        <h1>Logout</h1>
<p>The routes we have introduced have a <code>logout</code> route defined. However we need matching view/viewmodels:</p>
<h2>src/viewmodels/logout/logout.html</h2>
<pre><code>&lt;template&gt;

  &lt;form submit.delegate=&quot;logout($event)&quot; class=&quot;ui stacked segment form&quot;&gt;
    &lt;h3 class=&quot;ui header&quot;&gt;Are you sure you want to log out?&lt;/h3&gt;
    &lt;button class=&quot;ui blue submit button&quot;&gt;Logout&lt;/button&gt;
  &lt;/form&gt;

&lt;/template&gt;</code></pre>
<h2>src/viewmodels/logout/logout.html</h2>
<pre><code>import DonationService from &#39;../../services/donation-service&#39;;
import {inject} from &#39;aurelia-framework&#39;;

@inject(DonationService)
export class Logout {

  constructor(donationService) {
    this.donationService = donationService;
  }

  logout() {
    console.log(&#39;logging out&#39;);
    this.donationService.logout();
  }
}</code></pre>
<p>All should work now - with one exception (see exercises).</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="07.Exercises">
        <h1>Solution</h1>
<p>Archive of the lab so far:</p>
<ul>
<li><a href="https://bitbucket.org/edeleastar/donation-client/commits/tag/aurelia.3.end">https://bitbucket.org/edeleastar/donation-client/commits/tag/aurelia.3.end</a></li>
</ul>
<h2>Exercise 1: Deployment</h2>
<p>As an experiment, create a copy of the donation-client project, call it <code>donation-client-experiment</code>.</p>
<p>In the experiment version, delete all files <code>except</code> the following:</p>
<ul>
<li>index.html</li>
<li>scripts/<em>.</em></li>
</ul>
<p><img src="img/02.png" alt=""></p>
<p>Open the index.html file directly in a browser - the app should behave as previously.</p>
<p>Create a new git repository for the experiment - and commit all sources (that remain afgter our delete step)  to <code>gh-pages</code> branch. Push the repo as a new project to your github account. If everything goes according to plan, the app should be live with the url &#39;<a href="http://youraccount.github.com/donation-client-experiment">http://youraccount.github.com/donation-client-experiment</a>&#39; url</p>
<p>Examples:</p>
<p>The repository here is the experiment repo - note the branch name:</p>
<ul>
<li><a href="https://github.com/edeleastar/donation-client-experiment">https://github.com/edeleastar/donation-client-experiment</a></li>
</ul>
<p>This is automatically published here:</p>
<ul>
<li><a href="https://edeleastar.github.io/donation-client-experiment/">https://edeleastar.github.io/donation-client-experiment/</a></li>
</ul>
<h2>Exercises 2: Stats Viewmodel</h2>
<p>Run the app and look at the stats view. It seems to be perpetually set to 0. Why is this? Can you find a way of it displaying the correct view?</p>
<p>HINT: You should look at the <code>Component Lifecycle</code> documentation:</p>
<ul>
<li><a href="http://aurelia.io/hub.html#/doc/article/aurelia/framework/latest/creating-components/2">http://aurelia.io/hub.html#/doc/article/aurelia/framework/latest/creating-components/2</a></li>
</ul>
<p>In particular, the <code>attached</code> event/method.</p>
<h2>Exercise 3: Composite View/Viewmodel.</h2>
<p>Build a new view/view model - to appear on the menu as &#39;dashboard&#39; - which combines all existing views/viewmodels. This view model is visible in the app here:</p>
<ul>
<li><a href="https://edeleastar.github.io/donation-client-experiment/">https://edeleastar.github.io/donation-client-experiment/</a></li>
</ul>

      </div>
     
    </div>
  </div>
</div>
<!--<div class="ui bottom fixed borderless right menu">
  <div class="ui right tiny menu">
    <div class="ui mini message segment">
      .
      <a href="http://creativecommons.org/licenses/by-nc/4.0/"
         title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
         target="_blank">Creative Commons License
      </a>
    </div>
  </div>
</div>-->

<script>
  $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

</script>



    <footer>

    </footer>
    <script>
      $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>