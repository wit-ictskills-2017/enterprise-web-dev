 <!DOCTYPE html>
 <html>
   <head>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

     

     <style>
       

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}



     </style>

   </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom:thin solid black;
}

h2
{
  font-size:110%;
  border-bottom: thin solid black;
}

h3
{
  font-size:100%;
  border-bottom: thin solid black;
}

body
{
  overflow-y: scroll;
}

.pushable > .pusher
{
  padding-bottom: 1.5rem;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}



</style>

<div class="ui fixed top pointing inverted stackable menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      26: Aurelia/Hapi JWT
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="Lab-Hapi-JWT">
      Lab-Hapi-JWT
    </a>
    
    <a class="item" data-tab="01">
      01
    </a>
    
    <a class="item" data-tab="02">
      02
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" data-tab="05">
      05
    </a>
    
    <a class="item" data-tab="06">
      06
    </a>
    
    <a class="item" data-tab="07">
      07
    </a>
    
    <a class="item" data-tab="08.Exercises">
      08.Exercises
    </a>
    
    <div class="item">
      
    </div>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    <br><br>
    
      
        <a class="item" href="../../topic-02-js-review/book-1-javascript-intro/index.html">
          Lab-2.1 JS Intro
        </a>
      
    
      
        <a class="item" href="../../topic-02-js-review/book-2-javascript-fundamentals/index.html">
          Lab-2.2 JS Basics
        </a>
      
    
      
        <a class="item" href="../../topic-03-jquery+dom/book-3-jquery/index.html">
          Lab-3 JQuery
        </a>
      
    
      
        <a class="item" href="../../topic-04-ajax+apis/book-1-ajax-1/index.html">
          Lab-4.1 Github API
        </a>
      
    
      
        <a class="item" href="../../topic-04-ajax+apis/book-2-ajax-2/index.html">
          Lab-4.2-FoureSquare API
        </a>
      
    
      
        <a class="item" href="../../topic-05-applications/book-applications/index.html">
          Lab-5 Applications
        </a>
      
    
      
        <a class="item" href="../../topic-06-views/book-views/index.html">
          Lab-6 Views
        </a>
      
    
      
        <a class="item" href="../../topic-07-sessions/book-sessions/index.html">
          Lab-7 Sessions
        </a>
      
    
      
        <a class="item" href="../../topic-08-models/book-models/index.html">
          Lab-8 Models
        </a>
      
    
      
        <a class="item" href="../../topic-09-validation/book-validation/index.html">
          Lab-9 Validation
        </a>
      
    
      
        <a class="item" href="../../topic-10-deployment/book-deployment/index.html">
          Lab-10 Deployment
        </a>
      
    
      
        <a class="item" href="../../topic-11-seeding/book-seeding/index.html">
          Lab-11 Seeding
        </a>
      
    
      
        <a class="item" href="../../topic-12-api/book-api/index.html">
          Lab-12 Apis
        </a>
      
    
      
        <a class="item" href="../../topic-13-security-introduction/book-1-pgp-gpg/index.html">
          Lab-13 GPG
        </a>
      
    
      
        <a class="item" href="../../topic-14-security-foundations/book-1-openssl/index.html">
          Lab-14 OpenSSL and Certificates
        </a>
      
    
      
        <a class="item" href="../../topic-15-authentication+tls/book-1-tls-configuration/index.html">
          Lab-15 TLS Configuration
        </a>
      
    
      
        <a class="item" href="../../topic-16-tdd/book-tdd/index.html">
          Lab-16 Tdd
        </a>
      
    
      
        <a class="item" href="../../topic-17-webapp-threats+vulnerabilities/book-1-misuse-cases/index.html">
          Lab-17 Misuse Cases
        </a>
      
    
      
        <a class="item" href="../../topic-18-rest/book-rest/index.html">
          Lab-18 Rest
        </a>
      
    
      
        <a class="item" href="../../topic-19-web-app-authentication/book-1-web-authentication/index.html">
          Lab-19 Authentication techniques
        </a>
      
    
      
        <a class="item" href="../../topic-20-rest-client/book-rest-client/index.html">
          Lab-19 Java Rest Client
        </a>
      
    
      
        <a class="item" href="../../topic-21-aurelia-1/book-aurelia-1/index.html">
          Lab-Aurelia 1
        </a>
      
    
      
        <a class="item" href="../../topic-22-pentesting/book-1-burp-proxy/index.html">
          Lab-Burp-Proxy
        </a>
      
    
      
        <a class="item" href="../../topic-22-pentesting/book-2-regex/index.html">
          Regular Expressions
        </a>
      
    
      
        <a class="item" href="../../topic-22-pentesting/book-3-xss/index.html">
          XSS tips
        </a>
      
    
      
        <a class="item" href="../../topic-23-aurelia-2/book-aurelia-2/index.html">
          Lab-Aurelia 2
        </a>
      
    
      
        <a class="item" href="../../topic-24-aurelia-3/book-aurelia-3/index.html">
          Lab-Aurelia 3
        </a>
      
    
      
        <a class="item" href="../../topic-24-aurelia-3/book-aurelia-3-ts/index.html">
          Aurelia Lab 3 TS
        </a>
      
    
      
        <a class="item" href="../../topic-25-aurelia-4/book-aurelia-4/index.html">
          Lab-Aurelia 4
        </a>
      
    
      
        <a class="item" href="../../topic-25-aurelia-4/book-aurelia-ts-4/index.html">
          Lab-Aurelia 4 TS
        </a>
      
    
      
        <a class="active item" href="../../topic-26-aurelia-5/book-a-hapi-auth/index.html">
          Lab-Hapi-JWT
        </a>
      
    
      
        <a class="item" href="../../topic-26-aurelia-5/book-b-aurelia-5/index.html">
          Lab-Aurelia 5
        </a>
      
    
  </div>
  <div class="pusher" tabindex="-1">
    <div class="ui basic segment" id="labchat">
      <br>
      
      <div  class="ui tab segment lab" data-tab="Lab-Hapi-JWT">
        <h1>Objectives</h1>
<p>Incorporate JWT security strategy into the application, securing the api routes. Rework the test infrastructure to fully exercises the secure API.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="01">
        <h2>Delete Donations for a Candidate</h2>
<p>This is a new endpoint in Donation-Web to support deletion of candidates:</p>
<h2>routesapi.js</h2>
<pre><code>  { method: &#39;DELETE&#39;, path: &#39;/api/candidates/{id}/donations&#39;, config: DonationsApi.deleteDonations },</code></pre>
<h2>app/api/donationsapi.js</h2>
<pre><code>exports.deleteDonations = {

  auth: false,

  handler: function (request, reply) {
    Donation.remove({ candidate: request.params.id }).then(result =&gt; {
      reply().code(204);
    }).catch(err =&gt; {
      reply(Boom.badImplementation(&#39;error removing Donations&#39;));
    });
  },
};</code></pre>
<p>And then a test, also in donation-web:</p>
<h2>test/donationsapitest.js</h2>
<pre><code>  test(&#39;delete donations&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    for (var i = 0; i &lt; donations.length; i++) {
      donationService.makeDonation(returnedCandidate._id, donations[i]);
    }

    donationService.deleteDonations(returnedCandidate._id);
    const d = donationService.getDonations(returnedCandidate._id);
    assert.equal(d.length, 0);
  });
});</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="02">
        <h1>JWT Libraries</h1>
<p>Currently our API is completely open - as we have disabled any authentication strategy on each of these routes:</p>
<pre><code>...
  auth: false,
...</code></pre>
<p>This is deliberate, as the authentication strategy we have install in the app is unsuitable:</p>
<pre><code>  server.auth.strategy(&#39;session&#39;, &#39;cookie&#39;, true, {
    password: &#39;password-should-be-32-characters&#39;,
    cookie: &#39;donation&#39;,
    redirectTo: &#39;/login&#39;,
    isSecure: false,
  });</code></pre>
<p>This strategy utilities the browser cookie facility - is not appropriate for an API (where there may be no browser). We need an alternative strategy to secure the API.</p>
<p>One of the most common approaches is called <code>JSON Web Tokens</code>:</p>
<ul>
<li><a href="https://jwt.io/">https://jwt.io/</a></li>
</ul>
<p>and we will employ a simple version of it now. These are two libraries we will use:</p>
<ul>
<li><a href="https://github.com/dwyl/hapi-auth-jwt2">https://github.com/dwyl/hapi-auth-jwt2</a></li>
<li><a href="https://github.com/auth0/node-jsonwebtoken">https://github.com/auth0/node-jsonwebtoken</a></li>
</ul>
<p>Install both a part of our application:</p>
<pre><code>npm install hapi-auth-jwt2 -save
npm install jsonwebtoken -save</code></pre>
<h2>package.json</h2>
<pre><code>{
  &quot;name&quot;: &quot;donation-web&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;an application to host donations for candidates&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;node index&quot;,
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;dependencies&quot;: {
    &quot;boom&quot;: &quot;^3.2.2&quot;,
    &quot;handlebars&quot;: &quot;^4.0.5&quot;,
    &quot;hapi&quot;: &quot;^14.1.0&quot;,
    &quot;hapi-auth-cookie&quot;: &quot;^6.1.1&quot;,
    &quot;hapi-auth-jwt2&quot;: &quot;^7.0.1&quot;,
    &quot;inert&quot;: &quot;^4.0.1&quot;,
    &quot;joi&quot;: &quot;^9.0.4&quot;,
    &quot;jsonwebtoken&quot;: &quot;^7.1.9&quot;,
    &quot;lodash&quot;: &quot;^4.15.0&quot;,
    &quot;mongoose&quot;: &quot;^4.5.8&quot;,
    &quot;mongoose-seeder&quot;: &quot;^1.2.1&quot;,
    &quot;vision&quot;: &quot;^4.1.0&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;chai&quot;: &quot;^3.5.0&quot;,
    &quot;mocha&quot;: &quot;^3.0.2&quot;,
    &quot;sync-request&quot;: &quot;^3.0.1&quot;
  }
}</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>Authentication Route</h1>
<p>Our objective is to protect key routes so that they are only accessible to authenticated users. These users must bear a valid token, which serves to validate the user and enable their identity to be confirmed.</p>
<p>Before we create the routes + handlers to support this, we need some utility functions to generate and manipulate the tokens</p>
<h2>app/api/utils.js</h2>
<pre><code>const jwt = require(&#39;jsonwebtoken&#39;);

exports.createToken = function (user) {
  return jwt.sign({ id: user._id, email: user.email }, &#39;secretpasswordnotrevealedtoanyone&#39;, {
    algorithm: &#39;HS256&#39;,
    expiresIn: &#39;1h&#39;,
  });
};

exports.decodeToken = function (token) {
  var userInfo = {};
  try {
    var decoded = jwt.verify(token, &#39;secretpasswordnotrevealedtoanyone&#39;);
    userInfo.userId = decoded.id;
    userInfo.email = decoded.email;
  } catch (e) {
  }

  return userInfo;
};</code></pre>
<p>These use one of the libraries we have installed. The first method generates a token, and the second decodes an existing token, recovering the encrypted fields. In our case, we are basing the token on the User ID + email.</p>
<p>We now need a way to authenticate the users, using email+password which, if correct, will lead us to generate a token.</p>
<p>Here is a new route for this purpose:</p>
<h2>routesapi.js</h2>
<pre><code>  { method: &#39;POST&#39;, path: &#39;/api/users/authenticate&#39;, config: UsersApi.authenticate },</code></pre>
<p>The implementation:</p>
<pre><code>...
const utils = require(&#39;./utils.js&#39;);
...

exports.authenticate = {
  auth: false,
  handler: function (request, reply) {
    const user = request.payload;
    User.findOne({ email: user.email }).then(foundUser =&gt; {
      if (foundUser &amp;&amp; foundUser.password === user.password) {
        const token = utils.createToken(foundUser);
        reply({ success: true, token: token }).code(201);
      } else {
        reply({ success: false, message: &#39;Authentication failed. User not found.&#39; }).code(201);
      }
    }).catch(err =&gt; {
      reply(Boom.notFound(&#39;internal db failure&#39;));
    });
  },

};</code></pre>
<p>We will test this route in the next step.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>Testing Authenticate</h1>
<p>This is a skeleton to test the authentication routes:</p>
<h2>test/authapitest.js</h2>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const utils = require(&#39;../app/api/utils.js&#39;);

suite(&#39;Candidate API tests&#39;, function () {

  let users = fixtures.users;
  let newUser = fixtures.newUser;

  const donationService = new DonationService(fixtures.donationService);

  beforeEach(function () {
    donationService.deleteAllUsers();
  });

  afterEach(function () {
    donationService.deleteAllUsers();
  });

  test(&#39;authenticate&#39;, function () {
  });
});</code></pre>
<p>Note that we are including the <code>utils</code> functions from the main application. These will help us validate the token (for test purposes), but they are not exposed as part of the api.</p>
<p>In the test folder, we can extend the <code>DonationService</code> to support authenticate:</p>
<pre><code>  authenticate(user) {
    return this.httpService.post(&#39;/api/users/authenticate&#39;, user);
  }</code></pre>
<p>Here is a first simple test to verify that the route is wired up correctly:</p>
<pre><code>  test(&#39;authenticate&#39;, function () {
    const returnedUser = donationService.createUser(newUser);
    const response = donationService.authenticate(newUser);
    assert(response.success);
    assert.isDefined(response.token);
  });</code></pre>
<p>This should run successfully.</p>
<p>We could go one step further and verify that the token is correctly encoded:</p>
<pre><code>  test(&#39;verify Token&#39;, function () {
    const returnedUser = donationService.createUser(newUser);
    const response = donationService.authenticate(newUser);

    const userInfo = utils.decodeToken(response.token);
    assert.equal(userInfo.email, returnedUser.email);
    assert.equal(userInfo.userId, returnedUser._id);
  });</code></pre>
<p>Here we see if the userId and email can be successfully recovered from the token. We will not need to do this on the client, but this test helps firm up our understanding of how the tokens work.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="05">
        <h1>Securing API Routes</h1>
<p>Now that we have established the basic mechanism, we can incorporate jwt auth into the app itself.</p>
<h2>app/api/utils.js</h2>
<p>We first need a validation function:</p>
<pre><code>...
const User = require(&#39;../models/user&#39;);
...

exports.validate = function (decoded, request, callback) {
  User.findOne({ _id: decoded.id }).then(user =&gt; {
    if (user != null) {
      callback(null, true);
    } else {
      callback(null, false);
    }
  }).catch(err =&gt; {
    callback(null, false);
  });
};</code></pre>
<p>This function is required by the jwt validation strategy we are going to introduce. It will be passed the decoded token and will attempt to validate it. For our purposes, it is valid if it contains and ID for user in our database.</p>
<h2>index.js</h2>
<p>Now we can register the plugin:</p>
<pre><code>...
server.register([require(&#39;inert&#39;), require(&#39;vision&#39;), require(&#39;hapi-auth-cookie&#39;), require(&#39;hapi-auth-jwt2&#39;)], err =&gt; {
...</code></pre>
<p>Then we define a new strategy, which will be in addition to the strategy already in place:</p>
<pre><code>...
const utils = require(&#39;./app/api/utils.js&#39;);
...


  server.auth.strategy(&#39;jwt&#39;, &#39;jwt&#39;, {
    key: &#39;secretpasswordnotrevealedtoanyone&#39;,
    validateFunc: utils.validate,
    verifyOptions: { algorithms: [&#39;HS256&#39;] },
  });</code></pre>
<p><code>validateFunc</code> is specified here as part of the strategy.</p>
<h2>app/api/*api,js</h2>
<p>We now mark all of our api routes with this jwt strategy, replacing:</p>
<pre><code>  auth: false,</code></pre>
<p>with</p>
<pre><code>  auth: {
    strategy: &#39;jwt&#39;,
  },</code></pre>
<p>The ONE exception is the authenticate strategy, which must remain unguarded:</p>
<pre><code>exports.authenticate = {

  auth: false,
...</code></pre>
<p>(Otherwise users could not attempt to authenticate!).</p>
<p>Try running all tests now:</p>
<p><img src="img/05.png" alt=""></p>
<p>As we have guarded all the routes, all tests fail as our tests do not attempt any authentication (yet).</p>
<p>If you try to access the api from a browser we see similar problems:</p>
<p><img src="img/01.png" alt=""></p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="06">
        <h1>Jwt Test Support Classes</h1>
<p>All of our api routes are not reporting a missing authentication error:</p>
<p><img src="img/01.png" alt=""></p>
<p>This is because we are not providing the jwt token upon access. As we have already encapsulate http access in our tests, we can introduce jwt auth into the tests reasonably cleanly.</p>
<h2>test/sync-http-client.js</h2>
<p>This is a reimplementation of our lowest level htpp encapsulation class:</p>
<pre><code>var request = require(&#39;sync-request&#39;);

class SyncHttpService {

  constructor(baseUrl) {
    this.baseUrl = baseUrl;
    this.authHeadder = null;
  }

  setAuth(url, user) {
    const res = request(&#39;POST&#39;, this.baseUrl + url, { json: user });
    if (res.statusCode == 201) {
      var payload = JSON.parse(res.getBody(&#39;utf8&#39;));
      if (payload.success) {
        this.authHeadder = { Authorization: &#39;bearer &#39; + payload.token, };
        return true;
      }
    }

    this.authHeadder = null;
    return false;
  }

  clearAuth() {
    this.authHeadder = null;
  }

  get(url) {
    var returnedObj = null;
    var res = request(&#39;GET&#39;, this.baseUrl + url, { headers: this.authHeadder });
    if (res.statusCode &lt; 300) {
      returnedObj = JSON.parse(res.getBody(&#39;utf8&#39;));
    }

    return returnedObj;
  }

  post(url, obj) {
    var returnedObj = null;
    var res = request(&#39;POST&#39;, this.baseUrl + url, { json: obj, headers: this.authHeadder });
    if (res.statusCode &lt; 300) {
      returnedObj = JSON.parse(res.getBody(&#39;utf8&#39;));
    }

    return returnedObj;
  }

  delete(url) {
    var res = request(&#39;DELETE&#39;, this.baseUrl + url, { headers: this.authHeadder });
    return res.statusCode;
  }
}

module.exports = SyncHttpService;</code></pre>
<p>It included new methods <code>setAuth</code> and <code>clearAuth</code>, which manage the jwt tokens:</p>
<ul>
<li><code>setAuth</code> requests a token from the server, and stores in in an <code>authHeader</code> property.</li>
<li><code>clearAuth</code> clears out this property.</li>
</ul>
<p><code>get</code>, <code>post</code> and <code>delete</code> then include this header as part of all requests.</p>
<h2>test/donation-service.js</h2>
<p>In the <code>DonationService</code> class, delete the existing <code>authenticate</code> method, replacing with <code>login</code> and <code>logout</code>:</p>
<pre><code>  login(user) {
    return this.httpService.setAuth(&#39;/api/users/authenticate&#39;, user);
  }

  logout() {
    this.httpService.clearAuth();
  }</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="07">
        <h2>Jwt Enabled Unit Tests</h2>
<h2>authapitest.js</h2>
<p>We first simplify the auth test, removing one of the exploratory tests and focusing on a simple sanity check of the login/logout methods:</p>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const utils = require(&#39;../app/api/utils.js&#39;);

suite(&#39;Auth API tests&#39;, function () {

  let users = fixtures.users;
  let candidates = fixtures.candidates;

  const donationService = new DonationService(fixtures.donationService);

  test(&#39;login-logout&#39;, function () {
    var returnedCandidates = donationService.getCandidates();
    assert.isNull(returnedCandidates);

    const response = donationService.login(users[0]);
    returnedCandidates = donationService.getCandidates();
    assert.isNotNull(returnedCandidates);

    donationService.logout();
    returnedCandidates = donationService.getCandidates();
    assert.isNull(returnedCandidates);
  });
});</code></pre>
<p>Each of the other tests will need to be reworked - mostly just the <code>beforeEach</code> and <code>afterEach</code> functions, which can trigger the login/logout methods:</p>
<h2>test/candidateapitest.js</h2>
<pre><code>use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const _ = require(&#39;lodash&#39;);

suite(&#39;Candidate API tests&#39;, function () {

  let users = fixtures.users;
  let candidates = fixtures.candidates;
  let newCandidate = fixtures.newCandidate;

  const donationService = new DonationService(fixtures.donationService);

  beforeEach(function () {
    donationService.login(users[0]);
    donationService.deleteAllCandidates();
  });

  afterEach(function () {
    donationService.deleteAllCandidates();
    donationService.logout();
  });

  test(&#39;create a candidate&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    assert(_.some([returnedCandidate], newCandidate), &#39;returnedCandidate must be a superset of newCandidate&#39;);
    assert.isDefined(returnedCandidate._id);
  });

  test(&#39;get candidate&#39;, function () {
    const c1 = donationService.createCandidate(newCandidate);
    const c2 = donationService.getCandidate(c1._id);
    assert.deepEqual(c1, c2);
  });

  test(&#39;get invalid candidate&#39;, function () {
    const c1 = donationService.getCandidate(&#39;1234&#39;);
    assert.isNull(c1);
    const c2 = donationService.getCandidate(&#39;012345678901234567890123&#39;);
    assert.isNull(c2);
  });

  test(&#39;delete a candidate&#39;, function () {
    const c = donationService.createCandidate(newCandidate);
    assert(donationService.getCandidate(c._id) != null);
    donationService.deleteOneCandidate(c._id);
    assert(donationService.getCandidate(c._id) == null);
  });

  test(&#39;get all candidates&#39;, function () {
    for (let c of candidates) {
      donationService.createCandidate(c);
    }

    const allCandidates = donationService.getCandidates();
    assert.equal(allCandidates.length, candidates.length);
  });

  test(&#39;get candidates detail&#39;, function () {
    for (let c of candidates) {
      donationService.createCandidate(c);
    }

    const allCandidates = donationService.getCandidates();
    for (var i = 0; i &lt; candidates.length; i++) {
      assert(_.some([allCandidates[i]], candidates[i]), &#39;returnedCandidate must be a superset of newCandidate&#39;);
    }
  });

  test(&#39;get all candidates empty&#39;, function () {
    const allCandidates = donationService.getCandidates();
    assert.equal(allCandidates.length, 0);
  });
});</code></pre>
<h2>test/donationapitest.js</h2>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const _ = require(&#39;lodash&#39;);

suite(&#39;Donation API tests&#39;, function () {

  let users = fixtures.users;
  let donations = fixtures.donations;
  let newCandidate = fixtures.newCandidate;

  const donationService = new DonationService(fixtures.donationService);

  beforeEach(function () {
    donationService.login(users[0]);
    donationService.deleteAllCandidates();
    donationService.deleteAllDonations();
  });

  afterEach(function () {
    donationService.deleteAllCandidates();
    donationService.deleteAllDonations();
    donationService.logout();
  });

  test(&#39;create a donation&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    donationService.makeDonation(returnedCandidate._id, donations[0]);
    const returnedDonations = donationService.getDonations(returnedCandidate._id);
    assert.equal(returnedDonations.length, 1);
    assert(_.some([returnedDonations[0]], donations[0]), &#39;returned donation must be a superset of donation&#39;);
  });

  test(&#39;create multiple donations&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    for (var i = 0; i &lt; donations.length; i++) {
      donationService.makeDonation(returnedCandidate._id, donations[i]);
    }

    const returnedDonations = donationService.getDonations(returnedCandidate._id);
    assert.equal(returnedDonations.length, donations.length);
    for (var i = 0; i &lt; donations.length; i++) {
      assert(_.some([returnedDonations[i]], donations[i]), &#39;returned donation must be a superset of donation&#39;);
    }
  });

  test(&#39;delete all donations&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    for (var i = 0; i &lt; donations.length; i++) {
      donationService.makeDonation(returnedCandidate._id, donations[i]);
    }

    const d1 = donationService.getDonations(returnedCandidate._id);
    assert.equal(d1.length, donations.length);
    donationService.deleteAllDonations();
    const d2 = donationService.getDonations(returnedCandidate._id);
    assert.equal(d2.length, 0);
  });

  test(&#39;delete donations&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    for (var i = 0; i &lt; donations.length; i++) {
      donationService.makeDonation(returnedCandidate._id, donations[i]);
    }

    donationService.deleteDonations(returnedCandidate._id);
    const d = donationService.getDonations(returnedCandidate._id);
    assert.equal(d.length, 0);
  });
});</code></pre>
<p>Both of the above tests should now run successfully.</p>
<h2>test/userapitest.js</h2>
<p>The usersapitest will need a little more work - as we do not want to delete the account for the user we are logged in as! Here is a temporary version, which excludes some tests, but those remaining will all pass:</p>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const _ = require(&#39;lodash&#39;);

suite(&#39;User API tests&#39;, function () {

  let users = fixtures.users;
  let newUser = fixtures.newUser;

  const donationService = new DonationService(fixtures.donationService);

  beforeEach(function () {
    donationService.login(users[0]);
    //donationService.deleteAllUsers();
  });

  afterEach(function () {
    //donationService.deleteAllUsers();
    donationService.logout();
  });

  test(&#39;create a user&#39;, function () {
    const returnedUser = donationService.createUser(newUser);
    assert(_.some([returnedUser], newUser), &#39;returnedUser must be a superset of newUser&#39;);
    assert.isDefined(returnedUser._id);
  });

  test(&#39;get user&#39;, function () {
    const u1 = donationService.createUser(newUser);
    const u2 = donationService.getUser(u1._id);
    assert.deepEqual(u1, u2);
  });

  test(&#39;get invalid user&#39;, function () {
    const u1 = donationService.getUser(&#39;1234&#39;);
    assert.isNull(u1);
    const u2 = donationService.getUser(&#39;012345678901234567890123&#39;);
    assert.isNull(u2);
  });

  test(&#39;delete a user&#39;, function () {
    const u = donationService.createUser(newUser);
    assert(donationService.getUser(u._id) != null);
    donationService.deleteOneUser(u._id);
    assert(donationService.getUser(u._id) == null);
  });

  // test(&#39;get all users&#39;, function () {
  //   for (let u of users) {
  //     donationService.createUser(u);
  //   }
  //
  //   const allUsers = donationService.getUsers();
  //   assert.equal(allUsers.length, users.length);
  // });

  test(&#39;get users detail&#39;, function () {
    for (let u of users) {
      donationService.createUser(u);
    }

    const allUsers = donationService.getUsers();
    for (var i = 0; i &lt; users.length; i++) {
      assert(_.some([allUsers[i]], users[i]), &#39;returnedUser must be a superset of newUser&#39;);
    }
  });

  // test(&#39;get all users empty&#39;, function () {
  //   const allUsers = donationService.getUsers();
  //   assert.equal(allUsers.length, 0);
  // });
});</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="08.Exercises">
        <h1>Exercises</h1>
<p>Archive of the project so far:</p>
<ul>
<li><a href="https://bitbucket.org/edeleastar/donation-web-15/commits/all">https://bitbucket.org/edeleastar/donation-web-15/commits/all</a></li>
</ul>
<h2>Exercise 1: Record the donor when a donation is created.</h2>
<p>Currently, we the api is still not recording the <code>donor</code> for a given donation. We can verify this on our unit tests:</p>
<pre><code>  test(&#39;create a donation&#39;, function () {
    const returnedCandidate = donationService.createCandidate(newCandidate);
    donationService.makeDonation(returnedCandidate._id, donations[0]);
    const returnedDonations = donationService.getDonations(returnedCandidate._id);
    assert.equal(returnedDonations.length, 1);
    assert.isUndefined(returnedDonations[0].donor);
    assert(_.some([returnedDonations[0]], donations[0]), &#39;returned donation must be a superset of donation&#39;);
  }</code></pre>
<p>The second last line above:</p>
<pre><code>    assert.isUndefined(returnedDonations[0].donor);</code></pre>
<p>Verifies that the donor is not recorded. Try to make sure the donor is recorded in a field when the a donation is created</p>
<h2>HINT:</h2>
<p>This is an extract for the web controller fulfilling the same function:</p>
<h2>app/controllers/donations.js</h2>
<pre><code>exports.donate = {
  ...
  handler: function (request, reply) {
    var userEmail = request.auth.credentials.loggedInUser;
    let userId = null;
    let donation = null;
    User.findOne({ email: userEmail }).then(user =&gt; {
      ...
  },
  ...</code></pre>
<p>In the above, identifying the donor is via the logged in user:</p>
<pre><code>    var userEmail = request.auth.credentials.loggedInUser;</code></pre>
<p>For our api <code>makeDonation</code> function, the equivalent will be the token available via the request:</p>
<pre><code>exports.makeDonation = {
  ...

  handler: function (request, reply) {
    const donation = new Donation(request.payload);
    donation.candidate = request.params.id;

    const authorization = request.headers.authorization;
    // extract token, decode id and recover user id for donor.
    donation.donor = ????

    donation.donor = utils.getUserIdFromRequest(request);
    donation.save().then(newDonation =&gt; {
      reply(newDonation).code(201);
    }).catch(err =&gt; {
      reply(Boom.badImplementation(&#39;error making donation&#39;));
    });
  },

};</code></pre>
<p>Make sure to write a test to verify that donor is part of the donation.</p>

      </div>
     
    </div>
  </div>
</div>
<!--<div class="ui bottom fixed borderless right menu">
  <div class="ui right tiny menu">
    <div class="ui mini message segment">
      .
      <a href="http://creativecommons.org/licenses/by-nc/4.0/"
         title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
         target="_blank">Creative Commons License
      </a>
    </div>
  </div>
</div>-->

<script>
  $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

</script>



    <footer>

    </footer>
    <script>
      $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>